<!doctype html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Scorezone</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="https://scorez.one/" />
  <!-- Open Graph Meta Tags -->
  <meta property="og:url" content="https://scorez.one/">
  <meta property="og:type" content="website">
  <meta property="og:title" content="Scorezone">
  <meta property="og:description" content="https://scorez.one/">
  <meta property="og:image" content="https://scorez.one/assets/og-title.jpg">
  <meta property="og:image:width"" content="910">
  <meta property="og:image:height"" content="446">
  <!-- Twitter Meta Tags -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="twitter:domain" content="scorez.one">
  <meta property="twitter:url" content="https://scorez.one/">
  <meta name="twitter:title" content="Scorezone">
  <meta name="twitter:description" content="https://scorez.one/">
  <meta name="twitter:image" content="https://scorez.one/assets/og-title.jpg">
  <!-- favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
  <link rel="manifest" href="/assets/favicon/site.webmanifest">
  <!-- scripts -->
  <script src="https://cdn.tailwindcss.com"></script><!-- tailwind css -->
  <script src="https://unpkg.com/showdown@1.9.1/dist/showdown.min.js"></script><!-- markdown parser-->
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script><!-- toaster -->
  <script>
      gsheetData = {
          // https://docs.google.com/spreadsheets/d/1K9ODGumqgOMmOaZK_JcQh8CqgV27bljJherN4WylKFA/edit?usp=sharing
          documentId: "1K9ODGumqgOMmOaZK_JcQh8CqgV27bljJherN4WylKFA", // id from gsheet "shared with anyone"
          sheetName: "scorezone-database",
          cache: true,
      };
  </script><!-- data for js-gsheet.js -->
  <script src="/js-gsheet.js"></script><!-- gsheet.js -->
  <!-- css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" /><!-- Font Awesome icons -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" /><!-- font for retro style -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"><!-- toaster -->
  <style>
      .retro-font {
          font-family: "Press Start 2P", cursive;
      }

      .pixel-border {
          border-style: solid;
          border-width: 4px;
          border-color: #000;
          box-shadow: 8px 8px 0 rgba(0, 0, 0, 0.8);
      }

      .pixel-button {
          border-style: solid;
          border-width: 4px;
          border-color: #000;
          box-shadow: 4px 4px 0 rgba(0, 0, 0, 0.8);
          transition: all 0.1s ease;
      }

      .pixel-button:hover,
      .pixel-button.hover {
          transform: translate(2px, 2px);
          box-shadow: 2px 2px 0 rgba(0, 0, 0, 0.8);
      }

      .pixel-button:active,
      .pixel-button.active {
          transform: translate(4px, 4px);
          box-shadow: 0px 0px 0 rgba(0, 0, 0, 0.8);
      }

      .pixel-dots {
          background-image: radial-gradient(#000 2px, transparent 2px);
          background-size: 8px 8px;
      }

      .game-card {
          transition: all 0.3s ease;
      }

      .game-card:hover {
          transform: translateY(-5px) scale(1.02);
      }

      /* CRT screen effect */
      .crt::after {
          content: "";
          position: absolute;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          pointer-events: none;
          background:
              linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
              linear-gradient(
                  90deg,
                  rgba(255, 0, 0, 0.06),
                  rgba(0, 255, 0, 0.02),
                  rgba(0, 0, 255, 0.06)
              );
          background-size:
              100% 2px,
              3px 100%;
          z-index: 2;
      }
      .lazybg {
          background-image: none !important;
      }
  </style>

</head>
<body class="bg-purple-900 min-h-screen pixel-dots py-10">
  <div class="container mx-auto px-4">
      <!-- Header -->
      <header class="mb-12 text-center">
          <h1 class="retro-font text-4xl md:text-6xl text-yellow-300 mb-4 text-shadow-lg shadow-black">
            <span class="relative">
                <span class="absolute -left-2 -top-2 text-red-700">S</span>
                <span class="relative">SCOREZONE</span>
                <span class="absolute -right-2 -bottom-2 text-red-500">ONE</span>
            </span>
          </h1>
          <div class="relative inline-block">
              <button class="retro-font pixel-button bg-zinc-500 text-black px-6 py-3 text-[10px] hover:bg-zinc-300 transition-all">
                  <i onclick="location.href = location.href.split('#').shift();">Old And Unimproved.</i>
                  <span class="absolute -right-2 -top-2 retro-font bg-yellow-400 text-black px-2 py-1 text-[0.5em] pixel-border" >
                      &lt;3
                  </span>
              </button>
          </div>
      </header>

      <!-- Search Input -->
      <div class="mb-6 flex justify-center">
          <div class="relative w-full max-w-md">
              <input
                  type="text"
                  id="game-search"
                  class="retro-font w-full pixel-button bg-white text-black px-6 py-3 text-sm focus:outline-none"
                  placeholder="CERCA TITOLI, GIOCATORI..."
              />
              <div class="absolute right-4 top-1/2 transform -translate-y-1/2">
                  <i class="fas fa-search text-gray-700"></i>
              </div>
          </div>
      </div>

      <!-- Filter Controls -->
      <div class="mb-8 flex flex-wrap justify-center gap-4" id="filters">
        <button
              class="retro-font pixel-button bg-red-500 text-white px-4 py-2 text-xs active:bg-red-600 filter-btn selected"
              data-filter="all"
          >TUTTI</button>
        <!-- <button
              class="retro-font pixel-button bg-red-500 text-white px-4 py-2 text-xs active:bg-red-600 filter-btn"
              data-filter="all"
          >
              ALL GAMES
          </button>
          <button
              class="retro-font pixel-button bg-blue-500 text-white px-4 py-2 text-xs active:bg-blue-600 filter-btn"
              data-filter="action"
          >
              ACTION
          </button>
          <button
              class="retro-font pixel-button bg-green-500 text-white px-4 py-2 text-xs active:bg-green-600 filter-btn"
              data-filter="adventure"
          >
              ADVENTURE
          </button>
          <button
              class="retro-font pixel-button bg-yellow-500 text-black px-4 py-2 text-xs active:bg-yellow-600 filter-btn"
              data-filter="rpg"
          >
              RPG
          </button>
          <button
              class="retro-font pixel-button bg-purple-500 text-white px-4 py-2 text-xs active:bg-purple-600 filter-btn"
              data-filter="platformer"
          >
              PLATFORMER
          </button> -->
      </div>

      <!-- Game Cards -->
      <div
          class="
              relative
              grid
              grid-cols-1
              sm:grid-cols-2
              lg:grid-cols-3
              gap-8
              pb-10"
          id="game-container"
      >
          <!-- Cards will be inserted here by JavaScript -->
      </div>

      <!-- Game Card Template -->
      <template style="display: none;" id="game-card-template">
          <div class="absolute top-0 left-0 w-full no-h-1/3 h-48 bg-black bg-opacity-30 z-10"></div>
          <a
              href="#sfida-{challengeNum}"
              class="
                  absolute
                  pixel-border
                  px-2 py-1
                  retro-font
                  right-2
                  text-[10px]
                  text-white
                  top-2
                  z-20
                  {color}
              "
              title="Sfida n. {challengeNum}"
              data-action="clipboard-copy">
                  #{challengeNum}
          </a>

          <div class="relative h-48 overflow-hidden">
              <img
                  alt=" "
                  class="w-full h-full object-cover object-top"
                  loading="lazy"
                  src="{screenshot}">
          </div>

          <div class="p-4">
              <h3 class="retro-font text-white text-lg mb-4 overflow-hidden whitespace-nowrap text-ellipsis">{title}</h3>

              <div class="flex justify-between items-center mb-3">
                  <span class="retro-font text-xs text-white bg-blackk px-2 py-1 pixel-border">
                      {date}
                  </span>
                  <div class="text-xs" title="{playersCount} / 15 partecipanti">
                      {stars}
                  </div>
              </div>
              <button data-action="open-{challengeNum}" class="w-full retro-font pixel-button bg-white text-black py-2 text-xs hover:bg-gray-200 whitespace-nowrap overflow-hidden text-ellipsis">üèÜ {winnerName}</button>
          </div>

          <div class="absolute bottom-0 left-0 w-full h-1 bg-yellow-400"></div>
          <div class="absolute bottom-0 left-0 w-16 h-1 bg-red-500"></div>
      </template>

      <!-- Game Details Modal Template -->
      <template style="display: none;" id="game-details-template">
          <div
            data-action="close-modal"
            style="background-image: url({screenshot});"
            class=" bg-black bg-contain bg-opacity-90 bg-repeat bg-top fixed flex inset-0 items-center justify-center p-4 z-50">
              <div class="relative w-full max-w-4xl max-h-screen overflow-y-auto {game-color} pixel-border retro-font">
                  <!-- Close Button -->
                  <button
                      data-action="close-modal"
                      class="absolute top-4 right-4 z-60 bg-red-500 text-white px-3 py-2 pixel-button hover:bg-red-600 text-xs"
                      title="Chiudi">‚úï</button>

                  <!-- Header -->
                  <div class="bg-black bg-opacity-50 p-2 text-center">
                      <h1 class="text-yellow-300 text-xl md:text-xl mb-1">
                        {title}
                      </h1>
                      <h2 class="text-white text-xs mb-0">
                        SFIDA N. {challengeNum}
                      </h2>
                  </div>

                  <!-- Game Screenshot -->
                  <div class="relative h-64 md:h-80 overflow-hidden bg-black">
                      <img
                          loading="lazy"
                          src="{logo}"
                          alt="{title}"
                          class="w-full h-full object-contain">
                      <div class="absolute inset-0 bg-black bg-opacity-20"></div>
                  </div>

                  <!-- Game Info -->
                  <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                      <!-- Left Column - Game Details -->
                      <div>
                          <h3 class="text-yellow-300 text-sm mb-2 pixel-border inline-block px-2 py-1 bg-black">DETTAGLI GIOCO</h3>
                          <div class="space-y-3 text-white text-xs">
                              <div class="flex justify-between items-center py-1 border-b border-gray-600">
                                  <span class="text-gray-300">Romset:</span>
                                  <span class="text-white">{romset}</span>
                              </div>
                              <div class="flex justify-between items-center py-1 border-b border-gray-600">
                                  <span class="text-gray-300">Giocato:</span>
                                  <span class="text-white">{date}</span>
                              </div>
                              <div class="flex justify-between items-center py-1 border-b border-gray-600">
                                  <span class="text-gray-300">Partecipanti:</span>
                                  <span class="text-white">{playersCount} / 15</span>
                              </div>
                          </div>

                          <!-- Rules Section -->
                          <div class="mt-4">
                              <h4 class="text-yellow-300 text-sm mb-2 pixel-border inline-block px-2 py-1 bg-black">REGOLE</h4>
                              <div class="text-white text-xs leading-relaxed bg-black bg-opacity-30 p-2 pixel-border">
                                  {rules}
                              </div>
                          </div>
                      </div>

                      <!-- Right Column - Leaderboard -->
                      <div>
                        <h3 class="text-yellow-300 text-sm mb-2 pixel-border inline-block px-2 py-1 bg-black">CLASSIFICA</h3>
                        <div class="space-y-1">
                            {leaderboardHtml}
                        </div>
                      </div>
                  </div>

                  <!-- Footer Actions -->
                  <div class="p-4 bg-black bg-opacity-50 flex flex-wrap justify-end gap-2">
                      <button
                          data-action="clipboard-copy"
                          href="#sfida-{challengeNum}"
                          data-challenge="{challengeNum}"
                          class="bg-blue-500 text-white px-2 py-1 pixel-button hover:bg-blue-600 text-[10px]">
                          üìã LINK
                      </button>
                      <button
                          data-action="close-modal"
                          class="bg-gray-600 text-white px-2 py-1 pixel-button hover:bg-gray-700 text-[10px]">
                          ‚úï CHIUDI
                      </button>
                  </div>
              </div>
          </div>
      </template>

      <!-- Footer -->
      <footer class="mt-16 text-center retro-font text-yellow-600 text-xs">
          <p>¬© 2024-Today Scorezone</p>
          <p class="mt-2">NOT LICENSED BY ANYONE</p>
          <div class="mt-4 flex justify-center space-x-4 text-white">
              <i class="fas fa-gamepad"></i>
              <i class="fas fa-ghost"></i>
              <i class="fas fa-dragon"></i>
              <i class="fas fa-chess-pawn"></i>
          </div>
      </footer>


      <a href="#" title="torna all'inizio" class="
          fixed
          z-50
          bg-red-500
          bottom-4
          hover:bg-red-300
          p-2
          pl-3 pr-3
          pixel-button
          retro-font
          right-4
          transition-all
      ">
          <i class="fas fa-play fa-rotate-270"></i>
      </a>
  </div>


  <script>
    const SCOREZONE = {
        version: "v0.0.1",
        date: "2025-07-06",
        url: {
          getScreenshot: (gameID) => `https://scorez.one/assets/webp/${gameID}-screen.webp`,
          getLogo: (gameID) => `https://scorez.one/assets/webp/${gameID}-title.webp`,
        },
        localisation: {
          scheda_data_valore_default: '??',
          scheda_regole_valore_default: 'default settings',
          scheda_romset_valore_default: 'sconosciuto',
          scheda_sfidanum_valore_default: '??',
          scheda_vincitore_valore_default: '-n.a.-',
          toast_copiato: 'link copiato negli appunti',
        }
    };

    let games = []; // use it as a global storage for games data
    let selectedGame = window.location.hash.replace("#sfida-", "");
    renderGames(); // initial render with empty data

    initData()
      .then((scoresList) => {
        // scoresList data from CSV
        return loadGames(scoresList)
      })
      .then((loadedGames) => {
          // store the games
          games = loadedGames;
          // setup filters
          createYearFilters(games); // generate year filters based on the dataset, it's needed only once
          // render all games
          return renderGames({ games }); // render games after loading
      })
      .then(() => {
        // activate selected game
        if (selectedGame) {
            var el = document.querySelector(window.location.hash);

            el?.scrollIntoView({ behavior: "smooth", block: "start", inline: "nearest" });
            const openButton = document.querySelector(`[data-action="open-${selectedGame}"]`);
            openButton?.click();
          }
      })

    // setup search
    document.getElementById("game-search").addEventListener("input", debounce(() => {
        const filtered = filterGamesByAllTerms({ list: games, });
        renderGames({ games: filtered });
    }));

    // setup filter buttons
    document.getElementById("filters").addEventListener("click", (ev) => {
        if (!ev.target.getAttribute("data-filter")) return;
        const self = document.getElementById("filters");
        const buttons = self.querySelectorAll(".filter-btn");
        const swapClasses = [
          "bg-gray-800", "text-black", "text-white", "selected", "active"
        ];
        // reset all buttons
        buttons.forEach((btn) => {
            btn.classList.remove(...swapClasses);
            const filter = btn.getAttribute("data-filter");
            const color = getButtonColor(filter);
            btn.classList.add(color);
        });
        // set the clicked button
        const btn = ev.target;
        const filterValue = btn.getAttribute("data-filter");
        const color = getButtonColor(filterValue);
        btn.classList.remove(color);
        btn.classList.add(...swapClasses);

        const filtered = filterGamesByAllTerms({
          list: games,
        });
        // trigger the render with filtered games
        renderGames({ games: filtered });
    });

    // setup click events
    document.addEventListener("click", (ev) => {
        // const el = ev.target.closest("a");
        // const action = el ? el.getAttribute("data-action") : null;
        const el = ev.target.closest("[data-action]");
        const action = el ? el.getAttribute("data-action") : null;
        if (!action) return;

        if (action === "clipboard-copy") {
            const ael = ev.target.closest("[href]");
            ev.preventDefault();
            if (ael) {
                const text = window.location.toString().split('#')[0] + ael.getAttribute('href')
                copyToClipboard(text);
            }
        }

        if (action === "close-modal") {
            if (el != ev.target) return; // only close if clicked on the button itself
            ev.preventDefault();
            closeModal();
        }

        if (action.startsWith("open-")) {
            ev.preventDefault();
            const challengeNum = action.replace("open-", "");
            const game = games.find((g) => g.challengeNum == challengeNum);
            if (game) {
                showDetails(game);
                window.location.href = `#sfida-${game.challengeNum}`;
            }
        }
    });

    function filterGamesByAllTerms({list}) {
      const yearFiltered = filterGamesByYear({
        list: list,
        year: getYearFilterValue(),
      });
      const textFiltered = filterGamesByText({
          list: yearFiltered,
          text: getTextFilterValue(),
      });
      const result = textFiltered;
      return result || [];
    }

    function filterGamesByText({list, text}) {
      const found = list.filter((game) => game.fullTextSearch.includes(text));
      return found || [];
    }

    function filterGamesByYear({list, year}) {
      if (year === "all") {
        return list;
      }
      const found = list.filter((game) => game.year == year);
      return found || [];
    }

    function getTextFilterValue() {
        const searchInput = document.getElementById("game-search");
        const searchTerm = searchInput.value.toLowerCase();
        return searchTerm;
    }

    function getYearFilterValue() {
        const btn = document.getElementById("filters").querySelectorAll(".filter-btn.selected")[0];
        if (!btn) return "all";
        const filter = btn.getAttribute("data-filter");
        return filter.replace("year_", "");
    }

    // Fetch game data from CSV
    async function loadGames(games) {
      // prepare markdown converter
      const converter = new showdown.Converter();
      try {
          games = games.map((game) => {
              const id = game.id,
                  date = game.data,
                  challengeNum = game["sfida n."] ?? SCOREZONE.localisation.scheda_sfidanum_valore_default,
                  title = game.titolo
                      ? game.titolo.toUpperCase()
                      : "UNKNOWN GAME",
                  rules = converter.makeHtml(game.regole ?? SCOREZONE.localisation.scheda_regole_valore_default),
                  romset = converter.makeHtml(game.romset ?? SCOREZONE.localisation.scheda_romset_valore_default),
                  p1pts = game.pos_01_pts,
                  p1name = game.pos_01_name,
                  p2pts = game.pos_02_pts,
                  p2name = game.pos_02_name,
                  p3pts = game.pos_03_pts,
                  p3name = game.pos_03_name,
                  p4pts = game.pos_04_pts,
                  p4name = game.pos_04_name,
                  p5pts = game.pos_05_pts,
                  p5name = game.pos_05_name,
                  p6pts = game.pos_06_pts,
                  p6name = game.pos_06_name,
                  p7pts = game.pos_07_pts,
                  p7name = game.pos_07_name,
                  p8pts = game.pos_08_pts,
                  p8name = game.pos_08_name,
                  p9pts = game.pos_09_pts,
                  p9name = game.pos_9_name,
                  p10pts = game.pos_10_pts,
                  p10name = game.pos_10_name,
                  p11pts = game.pos_11_pts,
                  p11name = game.pos_11_name,
                  p12pts = game.pos_12_pts,
                  p12name = game.pos_12_name,
                  p13pts = game.pos_13_pts,
                  p13name = game.pos_13_name,
                  p14pts = game.pos_14_pts,
                  p14name = game.pos_14_name,
                  p15pts = game.pos_15_pts,
                  p15name = game.pos_15_name;

              // Extract year from date
              let d = SCOREZONE.localisation.scheda_data_valore_default;
              let simpleDate = SCOREZONE.localisation.scheda_data_valore_default;
              let year = new Date(date).getFullYear();
              if (date) {
                d = date ? new Date(date) : new Date();
                year = d.getFullYear();
                simpleDate = d.toLocaleDateString();
              }
              // Generate random genre for now since it's not in the CSV
              const genre = game.genere || null;
              const screenshot = SCOREZONE.url.getScreenshot(id);
              const logo = SCOREZONE.url.getLogo(id);

              const allNames = [
                  p1name,
                  p2name,
                  p3name,
                  p4name,
                  p5name,
                  p6name,
                  p7name,
                  p8name,
                  p9name,
                  p10name,
                  p11name,
                  p12name,
                  p13name,
                  p14name,
                  p15name,
              ];

              const playersCount = allNames.filter(
                  (name) => name && name.length,
              ).length;

              const fullTextSearch = [
                  `#${id}`,
                  challengeNum,
                  title,
                  simpleDate,
                  date,
                  ...allNames,
                  playersCount,
                  rules,
                  romset,
              ]
                  .join(" ")
                  .replace("\r", "")
                  .replace("\n", "")
                  .toLowerCase();
              return {
                  id,
                  challengeNum,
                  date,
                  simpleDate,
                  title,
                  rules,
                  romset,
                  year,
                  genre,
                  color: getColorForGame({ genre, title }),
                  players: [
                      { name: p1name, points: p1pts },
                      { name: p2name, points: p2pts },
                      { name: p3name, points: p3pts },
                      { name: p4name, points: p4pts },
                      { name: p5name, points: p5pts },
                      { name: p6name, points: p6pts },
                      { name: p7name, points: p7pts },
                      { name: p8name, points: p8pts },
                      { name: p9name, points: p9pts },
                      { name: p10name, points: p10pts },
                      { name: p11name, points: p11pts },
                      { name: p12name, points: p12pts },
                      { name: p13name, points: p13pts },
                      { name: p14name, points: p14pts },
                      { name: p15name, points: p15pts },
                  ].filter((p) => p.name && p.name.trim() !== ""),
                  logo,
                  screenshot,
                  playersCount,
                  fullTextSearch,
                  winnerName: p1name ?? SCOREZONE.localisation.scheda_vincitore_valore_default,
              };
          });

          games.sort((a, b) => {
              return a.challengeNum < b.challengeNum ? 1 : -1;
          });
          return games;
      } catch (error) {
          console.error("loadGames Error loading games:", error);
          renderGames();
          return [];
      }
    }

    function gameCardContentTemplate({game, template}) {
      if (!template) {
        console.error('Game card template not found');
        return '';
      }
      if (!game) {
        console.error('Game data is missing');
        return '';
      }
      const cardData = {
        [`{challengeNum}`]: game.challengeNum,
        [`{color}`]: game.color || "bg-gray-500",
        [`{date}`]: game.simpleDate || game.year || game.date || "n/a",
        [`{playersCount}`]: game.playersCount || 0,
        [`{romset}`]: game.romset || "n/a",
        [`{screenshot}`]: game.screenshot,
        [`{simpleDate}`]: game.simpleDate || "n/a",
        [`{stars}`]: generateStars(game),
        [`{title}`]: game.title,
        [`{winner}`]: game.winnerName ? `üèÜ ${game.winnerName}` : "n/a",
        [`{winnerName}`]: game.winnerName || null,
        [`{year}`]: game.year || "n/a",
        [`{logo}`]: game.logo || null,
      };
      let html = template;
      Object.entries(cardData).forEach(([placeholder, value]) => {
        html = html.replaceAll(placeholder, value);
      });
      return html;
    }

    // Create dynamic year filter buttons based on the dataset
    function createYearFilters(games) {
        if (!games || games.length === 0) return;

        // Find the min and max years in the dataset
        const years = games
            .map((game) => game.year)
            .filter((year) => year && !isNaN(year));
        if (years.length === 0) return;

        const startYear = Math.min(...years);
        const endYear = Math.max(...years);

        const yearFiltersContainer = document.getElementById("filters");

        // Generate a filter button for each decade
        const els = [];
        for (
            let currentYear = startYear;
            currentYear <= endYear;
            currentYear += 1
        ) {
            const yearName = currentYear;
            const yearButton = document.createElement("button");
            const yearFilter = `year_${currentYear}`;
            yearButton.className = `retro-font pixel-button text-black px-4 py-2 text-xs active:bg-purple-600 filter-btn`;
            yearButton.setAttribute("data-filter", yearFilter);
            yearButton.textContent = yearName;

            const buttonColor = getButtonColor(yearFilter);
            yearButton.classList.add(buttonColor);
            els.push(yearButton);
        }
        els.reverse();
        yearFiltersContainer.append(...els);
    }

    function getButtonColor(filter) {
        if (filter.startsWith("year")) {
            const colors = [
                "bg-blue-400",
                "bg-green-400",
                "bg-teal-400",
                "bg-red-400",
                "bg-fuchsia-400",
                "bg-yellow-400",
                "bg-orange-400",
                "bg-violet-400",
            ];
            const colorIndex =
                parseInt(filter.replace("year_", "")) % colors.length;
            return colors[colorIndex];
        }
        switch (filter) {
            case "all":
                return "bg-red-500";
            case "action":
                return "bg-blue-500";
            case "adventure":
                return "bg-green-500";
            case "rpg":
                return "bg-yellow-500";
            case "platformer":
                return "bg-purple-500";
            default:
                return "bg-gray-500";
        }
    }

    function getColorForGame({ genre, title }) {
        const colorsN = [
            "bg-amber-400",
            "bg-blue-400",
            "bg-cyan-400",
            "bg-emerald-400",
            "bg-fuchsia-400",
            "bg-green-400",
            "bg-indigo-400",
            "bg-lime-400",
            "bg-orange-400",
            "bg-pink-400",
            "bg-purple-400",
            "bg-red-400",
            "bg-sky-400",
            "bg-teal-400",
            "bg-violet-400",
            "bg-yellow-400",
        ];
        const colorsG = {
            action: colorsN[0],
            adventure: colorsN[1],
            rpg: colorsN[2],
            platformer: colorsN[3],
        };
        const gen = genre ? colorsG[genre.toLowerCase()] : null;
        const name = title ? colorsN[title.length % colorsN.length] : null;
        return gen || name || "bg-gray-500";
    }

    function renderEmptyList() {
      const container = document.getElementById("game-container");
      container.innerHTML = `
          <article class="
              absolute
              bg-red-400
              game-card
              overflow-hidden crt
              pixel-border
              right-0 left-0
              text-center
              text-white
              top-0
              w-full
              p-4
              retro-font
          ">
              <i>Nessun risultato. Cerca qualcos'altro.</i>
          </article>
      `;
      return container;
    }

    function renderSearching() {
      const container = document.getElementById("game-container");
      container.innerHTML = `
          <article class="
              absolute
              bg-stone-400
              game-card
              overflow-hidden crt
              pixel-border
              right-0 left-0
              text-center
              text-white
              top-0
              w-full
              p-4
              pt-10
              pb-10
              retro-font
          ">
              <i>Caricamento...</i>
          </article>
      `;
      return container;
    }

    // Update renderGames to use createGameCard
    function renderGames({ games = [] } = {}) {
        return new Promise((resolve, reject) => {
          renderSearching();
          debounce(() => {
            if (games.length === 0) {
                renderEmptyList();
                resolve([]);
                return;
            }
            const container = document.getElementById("game-container");
            const templateHtmlString = document.getElementById('game-card-template').innerHTML;
            container.innerHTML = "";
            games.forEach((game) => {
                const gameCard = createGameCard({game, templateHtmlString});
                container.appendChild(gameCard);
            });
            resolve(games);
          }, 220)();
        });
    }

    // Function to show game details in a modal or similar UI
    function showDetails(game) {
        const template = document.getElementById("game-details-template");
        if (!template) {
            console.error('Game details template not found');
            return;
        }

        // Generate leaderboard HTML
        const leaderboardHtml = game.players
            .filter(player => player.name && player.name.trim() !== '')
            .map((player, index) => {
                const position = index + 1;
                const isWinner = position === 1;
                const bgColor = isWinner ? 'bg-yellow-400 text-black' : 'bg-gray-700 text-white';
                const medal = position === 1 ? 'ü•á' : position === 2 ? 'ü•à' : position === 3 ? 'ü•â' : `${position}.`;

                return `
                    <div class="flex justify-between items-center p-2 ${bgColor} pixel-border mb-1">
                        <div class="flex items-center gap-2 overflow-hidden">
                            <span class="text-sm font-bold">${medal}</span>
                            <span
                              class="text-sm overflow-hidden whitespace-nowrap text-ellipsis"
                            >${player.name}</span>
                        </div>
                        <span
                          class="text-sm font-mono whitespace-nowrap"
                        >${player.points || 0} pts</span>
                    </div>
                `;
            }).join('');

        // Prepare template data
        const templateData = {
            '{challengeNum}': game.challengeNum || 'N/A',
            '{title}': game.title || 'Unknown Game',
            '{date}': game.simpleDate || game.date || 'N/A',
            '{stars}': generateStars(game),
            '{playersCount}': game.playersCount || 0,
            '{screenshot}': game.screenshot || '',
            '{logo}': game.logo || '',
            '{romset}': game.romset || 'N/A',
            '{rules}': game.rules || 'Default settings',
            '{leaderboardHtml}': leaderboardHtml,
            '{winnerName}': game.winnerName || 'N/A',
            '{winnerPoints}': game.players && game.players[0] ? game.players[0].points : 'N/A',
            '{game-color}': 'bg-gray-500',
        };

        // Clone template and replace placeholders
        let html = template.innerHTML;

        // Replace all placeholders
        Object.entries(templateData).forEach(([placeholder, value]) => {
            html = html.replaceAll(placeholder, value || 'N/A');
        });

        // Create modal container
        const modalContainer = document.createElement('div');
        modalContainer.id = 'game-details-modal';
        modalContainer.className = 'modal-container';
        modalContainer.setAttribute('data-slide', game.id);
        modalContainer.innerHTML = html;
        // Prevent body scroll
        document.body.style.overflow = 'hidden';
        // Add to body
        document.body.appendChild(modalContainer);
        document.addEventListener('keydown', closeModal);
    }

    // Function to close modal
    function closeModal(...args) {
        const event = args[0];
        // store for usage
        const modalContainer = document.querySelector('.modal-container');

        // next slide
        if (event && event.type && event.type === 'keydown' && event.key === 'ArrowRight') {
            const nextGame = findGameById({
              id: modalContainer.getAttribute('data-slide'),
              offset: +1
            });
            resetModal(modalContainer);
            showDetails(nextGame);
            return;
        }
        // prev slide
        if (event && event.type && event.type === 'keydown' && event.key === 'ArrowLeft') {
            const prevGame = findGameById({
              id: modalContainer.getAttribute('data-slide'),
              offset: -1
            });
            resetModal(modalContainer);
            showDetails(prevGame);
            return;
        }

        // prevent other keys from closing the modal
        if (event && event.type && event.type === 'keydown' && event.key !== 'Escape') {
            return; // only close on Escape key
        }

        // just close
        resetModal(modalContainer);
    }

    function resetModal(modalContainer) {
      if (modalContainer) {
            modalContainer.remove();
            // Prevent body scroll
            document.body.style.overflow = '';
          }
        document.body.style.overflow = '';
        document.removeEventListener('keydown', closeModal);
    }

    function findGameById({id, offset = 0}) {
        const found = games.find((game, index) => {
          return game.id === (Number.parseInt(id) + offset)
        });
        if (found) {
          return found;
        }
        if (offset <= 0) {
          return games[0];
        }
        return games[games.length - 1]
    }

    // Function to create game card (extracted for reuse)
    function createGameCard({game, templateHtmlString}) {
        const gameCard = document.createElement("article");
        gameCard.setAttribute("id", `sfida-${game.challengeNum}`);
        gameCard.setAttribute("data-action", `open-${game.challengeNum}`);
        gameCard.className = `game-card pixel-border ${game.color} relative overflow-hidden crt`;
        gameCard.innerHTML = gameCardContentTemplate({game, template: templateHtmlString});
        return gameCard;
    }

    // Function to generate star rating
    function generateStars({ playersCount }) {
        const rating = Math.round((playersCount / 15) * 5);
        let stars = "";
        for (let i = 0; i < 5; i++) {
            if (i < rating) {
                stars += '<i class="fas fa-star text-yellow-400"></i>';
            } else {
                stars += '<i class="far fa-star text-yellow-400"></i>';
            }
        }
        return stars;
    }

    function initData() {
        const gsheetData = window.gsheetData || {};
        const documentId = gsheetData.documentId || "";
        const sheetName = gsheetData.sheetName || "";
        const cache = gsheetData.cache || false;

        const doc = gsheetjs.downloadSheet({
            documentId: documentId,
            sheetName: sheetName,
            cache: cache,
        });
        // Promise to handle async loading
        return doc;
    }

    function copyToClipboard(text) {
        var success = false;
        try {
            // copy to clipboard
            navigator.clipboard.writeText(text);
            success = true;
        } catch (e) {
            success = false;
            console.error('copyToClipboard error', e);
        }
        if (success) {
            Toastify({
                text: SCOREZONE.localisation.toast_copiato,
                duration: 3000,
                className: `
                    retro-font
                    text-xs
                `,
                close: true,
                gravity: "bottom", // `top` or `bottom`
                position: "right", // `left`, `center` or `right`
                stopOnFocus: true, // Prevents dismissing of toast on hover
                style: {
                    background: '#fde047',
                    color: 'rgba(0, 0, 0, 0.9)',
                },
            }).showToast();
        }
    }

    function debounce (callback, wait = 160) {
        let timeoutId = null;

        return (...args) => {
            window.clearTimeout(timeoutId);

            timeoutId = window.setTimeout(() => {
                callback.apply(null, args);
            }, wait);
        };
    }
  </script>
</body>
</html>
